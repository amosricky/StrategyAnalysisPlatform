<?xml version="1.0" encoding="ISO-8859-1"?>
<AmiBroker-Analysis CompactMode="0">
<General>
<FormatVersion>1</FormatVersion>
<Symbol>2105</Symbol>
<FormulaPath>Formulas\\Imported\\7776.afl</FormulaPath>
<FormulaContent>//每次買固定100W\r\n//SetPositionSize(1000000, spsValue);\r\n//SetPositionSize(10000, spsShares);\r\n//分類型參數\r\nexitType = Optimize("exitType", 1, 1, 3, 1);\r\n\r\n//連續型參數\r\nbandMALen = Optimize("bandMALen", 20, 20, 120, 20);//6\r\nbandWidth = Optimize("bandWidth", 0.75, 0.75, 2, 0.25);//6\r\nfilterMaLen = Optimize("filterMaLen", 50, 50, 225, 25);//8\r\nexitInitPct = Optimize("exitInitPct", 4, 4, 20, 2);//9\r\n\r\nPrevious_Close = Ref( Close, -1 );\r\n\r\nbuyCond = false; \r\nfilterCond = false; \r\nexitCond1 = false; \r\ninitProtExitCond = false;\r\nexitCond = false;\r\n\r\n\r\n//布林通道\r\nupBand = BBandTop(close, bandMALen, bandWidth);\r\ndnBand = BBandBot(close, bandMALen, -bandWidth);\r\nmidBand = MA(close, bandMALen);\r\n\r\n\r\n//突破買進條件\r\nbuyCond = Cross(Close, upBand); // cross over\r\n\r\n//濾網\r\nfilterCond = close &gt; MA( c, filterMaLen);\r\n\r\n//買進\r\nBuy = (buyCond==True) and (filterCond==True);\r\n\r\nentryprice = ValueWhen( Buy, BuyPrice);\r\n//停損條件\r\ninitProtExitCond = Previous_Close &lt; entryprice*(1-(exitInitPct/100));\r\n\r\n\r\n//出場條件\r\nif(exitType == 1)\r\n{\r\n\texitCond1 = Cross(upBand, close);\r\n    exitCond = initProtExitCond or exitCond1;\r\n} \r\nelse if(exitType == 2)\r\n{\r\n\texitCond1 = Cross(midBand, close);\r\n    exitCond = initProtExitCond  or exitCond1 ;\r\n} \r\nelse if(exitType == 3)\r\n{\r\n\texitCond1 = Cross(dnBand, close);\r\n    exitCond = initProtExitCond  or exitCond1;\r\n} \r\n\r\n\r\nSell = (exitCond==True);\r\n\r\n//Buy and Entryprice\r\nif( LastValue( ValueWhen( Buy, BuyPrice)) != 0 ){\r\n    StaticVarSet("entryprice", LastValue( ValueWhen( Buy, BuyPrice)) );\r\n}\r\n\r\n    \r\n\r\n\r\n///////////////////////////////////////////////////////////////////////\r\n\r\nstock = FullName(); \t\t\r\nSetCustomBacktestProc("");\r\n\r\nif (Status("action") == actionPortfolio)\r\n{   \r\n    \r\n    bo = GetBacktesterObject();\t//  Get backtester object\r\n    \r\n    bo.PreProcess();\t//  Do pre-processing\r\n    thisbar = 0;  //當前回補index\r\n    lastbar = 0;  //最後一次訊號\r\n    shares = 0;\r\n    Buy_Price = 0;\r\n    Sell_Price = 0;\r\n    netprofit = 0;\r\n    lastsignal = "none";\r\n    position[0] = 0;\r\n    MAXNET = 0;\r\n    MAXMDD = 0;\r\n    MDD = 0;\r\n    dn = DateNum();\r\n    y = Year();\r\n    m = Month();\r\n    d = Day();\r\n    symbolname = "";\r\n    Last_Netprofit = 0;\r\n    GrossProfit = 0;\r\n    Grosslose = 0;\r\n    stats = bo.GetPerformanceStats( 0 );\r\n    capital = stats.GetValue("InitialCapital");\r\n    \r\n    \r\n    for (i = 0; i &lt; BarCount; i++)\t//  取得Symbol Name\r\n    {  \r\n       if(sig = bo.GetFirstSignal( i ))\r\n       {\r\n       symbolname = sig.Symbol;\t\r\n       \r\n       break;\r\n       }            \r\n    }\r\n    \r\n    fmkdir( "C:\\\\Users\\\\amosr\\\\Desktop\\\\MyWebsite\\\\StrategyPerformance\\\\BollingStrategy");\r\n    fmkdir( "C:\\\\Users\\\\amosr\\\\Desktop\\\\MyWebsite\\\\StrategyPerformance\\\\BollingStrategy\\\\"+symbolname);\r\n    filepath = "C:\\\\Users\\\\amosr\\\\Desktop\\\\MyWebsite\\\\StrategyPerformance\\\\BollingStrategy\\\\"+symbolname+"\\\\"+exitType+"_"+bandMALen+"_"+bandWidth+"_"+filterMaLen+"_"+exitInitPct+".csv";\r\n    fh = fopen( filepath, "a", True );\r\n    fputs("K-bars,Day,action,NetProfit"+"\\n", fh );\r\n    \r\n    \r\n    \r\n    \r\n    for (i = 0; i &lt; BarCount; i++)\t//  Loop through all bars\r\n    {       \r\n        for (sig = bo.GetFirstSignal( i ); sig; sig = bo.GetNextSignal( i ) )\r\n        {\t//  Loop through all signals at this bar\r\n            \r\n\t\t\tlastbar = i;//紀錄當前訊號的index\r\n\t\t\t\r\n\t\t\tif (sig.IsEntry() ) \r\n            {\r\n              \r\n                bo.EnterTrade( i, sig.Symbol, sig.IsLong(), sig.Price,sig.PosSize );\r\n                \r\n                Buy_Price = sig.Price;\r\n                openpos = bo.GetFirstOpenPos();\r\n                \r\n                if(openpos){\r\n\t\t\t\t\tshares = openpos.Shares();//pb//\r\n\t\t\t\t\tposition[i] = openpos.GetPositionValue();//pb//\r\n\t\t\t\t}\r\n\t\t\t\t\r\n                \r\n                if (lastsignal=="none")\r\n                {   \r\n\t\t\t\t\tfor (f=thisbar;f&lt;lastbar;f++)\r\n\t\t\t\t\t{         \r\n\t\t\t\t\t\tfputs(NumToStr(f+1)+","+y[f]+"/"+m[f]+"/"+d[f]+","+"Waiting"+","+NumToStr(netprofit)+"\\n",fh);\r\n\t\t\t\t\t}\r\n                }\r\n                \r\n                \r\n                if (lastsignal=="Sell")\r\n                {\r\n\t\t\t\t\tfor (f=thisbar+1;f&lt;lastbar;f++)\r\n\t\t\t\t\t{           \r\n\t\t\t\t\t\tfputs(NumToStr(f+1)+","+y[f]+"/"+m[f]+"/"+d[f]+","+"Waiting"+","+NumToStr(netprofit)+"\\n",fh);\t\r\n\t\t\t\t\t}\r\n                }\r\n                \r\n\t\t\t\t\r\n\t\t\t\tlastsignal = "Buy";\r\n\t\t\t\t\r\n\t\t\t\tnetprofit = netprofit ; //(Buy_Price*shares)-capital;\r\n\t\t\t\t\r\n\t\t\t\tif (netprofit&gt;MAXNET)\r\n\t\t\t\t   { \r\n\t\t\t\t   MAXNET = netprofit; \r\n\t\t\t\t   }\r\n\t\t\t\t\r\n\t\t\t\tfputs(NumToStr(i+1)+","+y[i]+"/"+m[i]+"/"+d[i]+","+"Buy"+","+NumToStr(netprofit)+"\\n",fh);\r\n\t\t\t  \r\n\t\t\t\t\r\n            }\r\n\t\t\t\r\n\t\t\tif ( sig.IsExit() )\r\n            {    \r\n                bo.EnterTrade( i, sig.Symbol, sig.IsLong(), sig.Price,sig.PosSize );\r\n                Sell_Price = sig.Price;\r\n                for ( openpos = bo.GetFirstOpenPos(); openpos; openpos = bo.GetNextOpenPos() )        \r\n\t\t\t\t{ \r\n\t\t\t\t     //Sell_Price = openpos.EntryPrice();\r\n\t\t\t\t\t if (lastsignal=="Buy")\r\n                     {             \r\n\t\t\t\t\t\tfor (f=thisbar+1;f&lt;lastbar;f++)\r\n\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\ttemp = (openpos.GetPrice(f,"C")-Buy_Price)*shares;\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tposition[f] = openpos.GetPrice(f,"C")*shares;\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tif ((temp+netprofit)&gt;MAXNET)\r\n\t\t\t\t\t\t\t\t{ \r\n\t\t\t\t\t\t\t\tMAXNET = (temp+netprofit); \r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tfputs(NumToStr(f+1)+","+y[f]+"/"+m[f]+"/"+d[f]+","+"Holding"+","+NumToStr(temp+netprofit)+"\\n",fh);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tnetprofit = (Sell_Price-Buy_Price)*shares + netprofit;\r\n                     }\r\n\t\t\t\t\t\r\n\t\t\t\t\tbo.ExitTrade( i, sig.Symbol, sig.Price );\r\n\t\t\t\t\t//netprofit = (sig.Price-Buy_Price)*shares;\r\n\t\t\t\t\t//netprofit = openpos.GetProfit();\r\n\t\t\t\t\tposition[i] = openpos.GetPositionValue();\r\n\t\t\t\t\t\r\n\t\t\t\t\tif (position[i]&gt;MAXMDD)\r\n\t\t\t\t        {\r\n\t\t\t\t        MAXMDD = position[i];\r\n\t\t\t\t        }  \r\n\t\t\t\t    \r\n\t\t\t\t    //MDD = MAXMDD - position[i];\r\n\t\t\t\t    if (netprofit&gt;MAXNET)\r\n\t\t\t\t\t\t{ \r\n\t\t\t\t\t\tMAXNET = netprofit; \r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\t    barday = DateTimeConvert( 0, openpos.ExitDateTime );\r\n\t\t\t\t\tfputs(NumToStr(i+1)+","+y[i]+"/"+m[i]+"/"+d[i]+","+"Sell"+","+NumToStr(netprofit)+"\\n",fh);\r\n\t\t\t\t\tlastsignal = "Sell";\r\n\t\t\t\t\tLast_Netprofit = netprofit;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tthisbar = i; //記錄此次回補資料完的位置\r\n        }\t\r\n        \r\n        \r\n        \r\n        bo.HandleStops( i );\t//  Handle programmed stops at this bar\r\n        bo.UpdateStats( i, 1 );\t//  Update MAE/MFE stats for bar\r\n        bo.UpdateStats( i, 2 );\t//  Update stats at bar's end\r\n        \r\n\t\t\r\n    }\t//  End of for loop over bars\r\n    \r\n    for(f=lastbar+1;f&lt;BarCount;f++)\r\n       {\r\n\t\tif(lastsignal=="Sell")\r\n\t\t\t{\r\n\t\t\t fputs(NumToStr(f+1)+","+y[f]+"/"+m[f]+"/"+d[f]+","+"Waiting"+","+NumToStr(netprofit)+"\\n",fh);\r\n\t\t    }\r\n\t\t\r\n\t\tif(lastsignal=="Buy")\r\n\t\t\t{\r\n\t\t\t fputs(NumToStr(f+1)+","+y[f]+"/"+m[f]+"/"+d[f]+","+"Holding"+","+NumToStr(netprofit)+"\\n",fh);//帶修正\r\n\t\t\t}\r\n       }\r\n    fclose( fh );\r\n    bo.PostProcess();\t//  Do post-processing\r\n    \r\n}\r\n\r\n\r\n\r\n\r\n</FormulaContent>
<ApplyTo>1</ApplyTo>
<RangeType>3</RangeType>
<RangeAmount>7</RangeAmount>
<FromDate>1988-01-01 00:00:00</FromDate>
<ToDate>2017-01-01</ToDate>
<SyncOnSelect>0</SyncOnSelect>
<RunEvery>0</RunEvery>
<RunEveryInterval>5min</RunEveryInterval>
<IncludeFilter>
<ExcludeMode>0</ExcludeMode>
<OrSelection>0</OrSelection>
<Favourite>0</Favourite>
<Index>0</Index>
<Type0>0</Type0>
<Category0>-1</Category0>
<Type1>1</Type1>
<Category1>-1</Category1>
<Type2>2</Type2>
<Category2>-1</Category2>
<Type3>3</Type3>
<Category3>-1</Category3>
<Type4>4</Type4>
<Category4>-1</Category4>
<Type5>5</Type5>
<Category5>-1</Category5>
<Type6>6</Type6>
<Category6>-1</Category6>
</IncludeFilter>
<ExcludeFilter>
<ExcludeMode>1</ExcludeMode>
<OrSelection>0</OrSelection>
<Favourite>0</Favourite>
<Index>0</Index>
<Type0>0</Type0>
<Category0>-1</Category0>
<Type1>1</Type1>
<Category1>-1</Category1>
<Type2>2</Type2>
<Category2>-1</Category2>
<Type3>3</Type3>
<Category3>-1</Category3>
<Type4>4</Type4>
<Category4>-1</Category4>
<Type5>5</Type5>
<Category5>-1</Category5>
<Type6>6</Type6>
<Category6>-1</Category6>
</ExcludeFilter>
</General>
<BacktestSettings>
<InitialEquity>1000000</InitialEquity>
<TradeFlags>1</TradeFlags>
<MaxLossStopMode>0</MaxLossStopMode>
<MaxLossStopValue>0</MaxLossStopValue>
<MaxLossStopAtStop>1</MaxLossStopAtStop>
<ProfitStopMode>0</ProfitStopMode>
<ProfitStopValue>0</ProfitStopValue>
<ProfitStopAtStop>1</ProfitStopAtStop>
<TrailingStopMode>0</TrailingStopMode>
<TrailingStopPeriods>0</TrailingStopPeriods>
<TrailingStopValue>0</TrailingStopValue>
<TrailingStopAtStop>1</TrailingStopAtStop>
<CommissionMode>0</CommissionMode>
<CommissionValue>0</CommissionValue>
<BuyPriceField>0</BuyPriceField>
<BuyDelay>1</BuyDelay>
<SellPriceField>0</SellPriceField>
<SellDelay>1</SellDelay>
<ShortPriceField>1</ShortPriceField>
<ShortDelay>1</ShortDelay>
<CoverPriceField>1</CoverPriceField>
<CoverDelay>1</CoverDelay>
<ReportSystemFormula>0</ReportSystemFormula>
<ReportSystemSettings>0</ReportSystemSettings>
<ReportOverallSummary>1</ReportOverallSummary>
<ReportSummary>1</ReportSummary>
<ReportTradeList>1</ReportTradeList>
<LoadRemainingQuotes>1</LoadRemainingQuotes>
<Periodicity>0</Periodicity>
<InterestRate>0</InterestRate>
<ReportOutPositions>1</ReportOutPositions>
<UseConstantPriceArrays>0</UseConstantPriceArrays>
<PointsOnlyTest>0</PointsOnlyTest>
<AllowShrinkingPosition>0</AllowShrinkingPosition>
<RangeType>3</RangeType>
<RangeLength>6</RangeLength>
<RangeFromDate>1988-01-01 00:00:00</RangeFromDate>
<RangeToDate>2017-01-01</RangeToDate>
<ApplyTo>1</ApplyTo>
<FilterQty>2</FilterQty>
<IncludeFilter>
<ExcludeMode>0</ExcludeMode>
<OrSelection>0</OrSelection>
<Favourite>0</Favourite>
<Index>0</Index>
<Type0>0</Type0>
<Category0>-1</Category0>
<Type1>1</Type1>
<Category1>-1</Category1>
<Type2>2</Type2>
<Category2>-1</Category2>
<Type3>3</Type3>
<Category3>-1</Category3>
<Type4>4</Type4>
<Category4>-1</Category4>
<Type5>5</Type5>
<Category5>-1</Category5>
<Type6>6</Type6>
<Category6>-1</Category6>
</IncludeFilter>
<ExcludeFilter>
<ExcludeMode>1</ExcludeMode>
<OrSelection>0</OrSelection>
<Favourite>0</Favourite>
<Index>0</Index>
<Type0>0</Type0>
<Category0>-1</Category0>
<Type1>1</Type1>
<Category1>-1</Category1>
<Type2>2</Type2>
<Category2>-1</Category2>
<Type3>3</Type3>
<Category3>-1</Category3>
<Type4>4</Type4>
<Category4>-1</Category4>
<Type5>5</Type5>
<Category5>-1</Category5>
<Type6>6</Type6>
<Category6>-1</Category6>
</ExcludeFilter>
<UseOptimizedEvaluation>0</UseOptimizedEvaluation>
<BacktestRangeType>0</BacktestRangeType>
<BacktestRangeLength>6</BacktestRangeLength>
<BacktestRangeFromDate>1988-01-01 00:00:00</BacktestRangeFromDate>
<BacktestRangeToDate>2003-12-31</BacktestRangeToDate>
<MarginRequirement>100</MarginRequirement>
<SameDayStops>1</SameDayStops>
<RoundLotSize>0</RoundLotSize>
<TickSize>0</TickSize>
<DrawdownPriceField>0</DrawdownPriceField>
<ReverseSignalForcesExit>1</ReverseSignalForcesExit>
<NoDefaultColumns>0</NoDefaultColumns>
<AllowSameBarExit>0</AllowSameBarExit>
<ExtensiveOptimizationWarning>0</ExtensiveOptimizationWarning>
<WaitForBackfill>0</WaitForBackfill>
<MaxRanked>4</MaxRanked>
<MaxTraded>4</MaxTraded>
<MaxTracked>100</MaxTracked>
<PortfolioReportMode>0</PortfolioReportMode>
<MinShares>1</MinShares>
<SharpeRiskFreeReturn>5</SharpeRiskFreeReturn>
<PortfolioMode>0</PortfolioMode>
<PriceBoundCheck>1</PriceBoundCheck>
<AlignToReferenceSymbol>0</AlignToReferenceSymbol>
<ReferenceSymbol>^DJI</ReferenceSymbol>
<UPIRiskFreeReturn>5.4</UPIRiskFreeReturn>
<NBarStopMode>0</NBarStopMode>
<NBarStopValue>0</NBarStopValue>
<NBarStopReentryDelay>0</NBarStopReentryDelay>
<MaxLossStopReentryDelay>0</MaxLossStopReentryDelay>
<ProfitStopReentryDelay>0</ProfitStopReentryDelay>
<TrailingStopReentryDelay>0</TrailingStopReentryDelay>
<AddFutureBars>0</AddFutureBars>
<DistChartSpacing>5</DistChartSpacing>
<ProfitDistribution>1</ProfitDistribution>
<MAFEDistribution>1</MAFEDistribution>
<IndividualDetailedReports>1</IndividualDetailedReports>
<PortfolioReportTradeList>1</PortfolioReportTradeList>
<LimitTradeSizeAsPctVol>0</LimitTradeSizeAsPctVol>
<DisableSizeLimitWhenVolumeIsZero>1</DisableSizeLimitWhenVolumeIsZero>
<UsePrevBarEquityForPosSizing>0</UsePrevBarEquityForPosSizing>
<NBarStopHasPriority>1</NBarStopHasPriority>
<UseCustomBacktestProc>0</UseCustomBacktestProc>
<CustomBacktestProcFormulaPath/>
<MinPosValue>0</MinPosValue>
<MaxPosValue>0</MaxPosValue>
<ChartInterval>86400</ChartInterval>
<DisableRuinStop>0</DisableRuinStop>
<OptTarget>Net Profit</OptTarget>
<WFMode>1</WFMode>
<GenerateReport>0</GenerateReport>
<MaxLongPos>0</MaxLongPos>
<MaxShortPos>0</MaxShortPos>
<SeparateLongShortRank>0</SeparateLongShortRank>
<TotalSymbolQty>1</TotalSymbolQty>
<EnableUserReportCharts>1</EnableUserReportCharts>
<ChartWidth>800</ChartWidth>
<ChartHeight>480</ChartHeight>
<SettlementDelay>0</SettlementDelay>
<PortfolioReportSystemFormula>1</PortfolioReportSystemFormula>
<InterestRateSymbol/>
<MarginRate>0</MarginRate>
<IncludeBHStats>1</IncludeBHStats>
<BHSymbol>^DJI</BHSymbol>
<MCEnable>1</MCEnable>
<MCRuns>10000</MCRuns>
<MCPosSizeMethod>0</MCPosSizeMethod>
<MCPosSizeShares>100</MCPosSizeShares>
<MCPosSizeValue>1000</MCPosSizeValue>
<MCPosSizePctEquity>5</MCPosSizePctEquity>
<MCChartEquityCurves>1</MCChartEquityCurves>
<MCStrawBroomLines>0</MCStrawBroomLines>
<Scenario>0</Scenario>
<MCChartEquityScale>0</MCChartEquityScale>
<MCUseEquityChanges>1</MCUseEquityChanges>
<MCLogScaleFinalEquity>0</MCLogScaleFinalEquity>
<MCLogScaleDrawdown>0</MCLogScaleDrawdown>
<MCNegativeDrawdown>1</MCNegativeDrawdown>
<ISEnabled>1</ISEnabled>
<ISStartDate>1988-01-01</ISStartDate>
<ISEndDate>1991-12-31</ISEndDate>
<ISLastDate>2017-01-01</ISLastDate>
<ISStep>4</ISStep>
<ISStepUnit>3</ISStepUnit>
<ISAnchored>0</ISAnchored>
<ISLastUsesToday>0</ISLastUsesToday>
<OSEnabled>1</OSEnabled>
<OSStartDate>1992-01-01</OSStartDate>
<OSEndDate>1995-12-31</OSEndDate>
<OSLastDate>2021-12-31</OSLastDate>
<OSStep>4</OSStep>
<OSStepUnit>3</OSStepUnit>
<OSAnchored>0</OSAnchored>
<OSLastUsesToday>0</OSLastUsesToday>
</BacktestSettings>
</AmiBroker-Analysis>
